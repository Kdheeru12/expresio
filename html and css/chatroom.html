
{% load static  %}
{% if auth.is_authenticated %}
<!DOCTYPE html>
<html  >
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" type="image/x-icon" href=" {% static 'assets/img/favicon.jpeg' %} ">
  <meta name="description"    content="EXPRESIO TO WRITE AND READ">
  <meta name="keywords"       content="BLOGS POSTS LIKES COMMENTS SHARES">



  <title>EXPRESSIO CREATE POST</title>
  <link rel="stylesheet" href=" {% static 'css/assets1/bootstrap/css/bootstrap.min.css'  %}   ">
  <link rel="stylesheet" href=" {% static 'css/assets1/bootstrap/css/bootstrap-grid.min.css'  %}  ">
  <link rel="stylesheet" href=" {% static 'css/assets1/bootstrap/css/bootstrap-reboot.min.css'  %}  ">
  <link rel="stylesheet" href=" {% static 'css/assets1/tether/tether.min.css'  %} ">
  <link rel="stylesheet" href=" {% static 'css/assets1/theme/css/style.css'  %}   ">
  <link rel="preload" as="style" href=" {% static 'css/assets1/mobirise/css/mbr-additional.css'  %} ">
  <link rel="stylesheet" href="   {% static 'css/assets1/mobirise/css/mbr-additional.css'  %}  " type="text/css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


</head>

<body>
  <section class="mbr-section form1 cid-s48bJZGPY0" id="form1-n">


    <input type="hidden" id="current_user" value="{{user}}">
    <input type="hidden" id="current_user_id" value={{auth}}>
    <input type="hidden" id="current_room_id">

    <div class="container">
        <div class="row justify-content-center">
            <div class="title col-12 col-lg-8">
                <h2 class="mbr-section-title align-center pb-3 mbr-fonts-style display-2">Chat Room</h2>
                <h3 class="mbr-section-subtitle align-center mbr-light pb-3 mbr-fonts-style display-5">{{roomname}}<br></h3>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="media-container-column col-lg-12" data-form-type="formoid">
                <!---Formbuilder Form--->
                    <div class="row">

                        <div hidden="hidden" data-form-alert-danger="" class="alert alert-danger col-12">
                        </div>
                    </div>
                        <!-- {{ form.media}}
                        {{form.as_p}} -->
                        <div class="shadow p-4 mb-4 bg-white">
                            
                            <div id="chat_header" class="mt-3">
                              <div class="alert alert-success alert-dismissible text-center mt-3">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                Hello {{ user }}!
                              </div>
                            </div>
                          
                            <div id="chat_box" class="border p-3 my-3" style="height: 300px;overflow: auto;">
                                <ul style="list-style-type:none;padding: 0;" id="messages" class="mt-3">
                                </ul>
                            </div>
                          
                            <div class="input-group mb-3" id="input_group">
                              <input type="text" class="form-control" placeholder="Some text" id="send_message">
                              <div class="input-group-append">
                                  <button class="btn btn-outline-primary" type="button" id="send">Send</button>
                              </div>
                            </div>
                          </div>
                          {{ roomname|json_script:"roomname" }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

  <script src="  {% static 'css/assets1/popper/popper.min.js'  %} "></script>
  <script src="  {% static 'css/assets1/bootstrap/js/bootstrap.min.js'  %} "></script>
  <script src="  {% static 'css/assets1/tether/tether.min.js'  %} "></script>
  <script src="  {% static 'css/assets1/smoothscroll/smooth-scroll.js'  %} "></script>
  <script src="  {% static 'css/assets1/theme/js/script.js'  %} "></script>
</body>

<script>
console.log('ddd');
$(document).ready(function(){
console.log('dddw');
  const messages_container = document.getElementById('chat_box');
  let roomName = JSON.parse(document.getElementById('roomname').textContent);
  var loc = window.location;
  var wsStart = 'ws://';
  senderID = $('#current_user_id').val()
  if(loc.protocol == 'https:'){
    var wsStart = 'wss://';
  }

  let chatSocket = new WebSocket(
    wsStart
      + window.location.host
      + '/ws/chatrooms/'
      + roomName
      + '/'
  );
  console.log("chatSocket", chatSocket);
  chatSocket.onopen = function(e) {
      chatSocket.send(JSON.stringify({
          'message': 'get-room-messages'
      }));
  };

  chatSocket.onmessage = function(e) {
    let message = JSON.parse(e.data)['message'];
    if(message['message-type']=='get-room-messages'){
      message_body = JSON.parse(message['message-body']);
    console.log("test",message_body);
    console.log(message['message-body'],$('#current_user_id').val());

      let saved_messages = "";
      for(let i=0;i<message_body.length;i++){
          saved_messages +=
          '<li>'+
              '<div class="d-flex justify-content-start mb-3">'+
                  '<div class="w-75 border border-danger rounded-lg p-2">'+
                      '<strong>'+ message_body[i]['fields']['sender'] +'</strong><br>'+
                      message_body[i]['fields']['message'] +
                  '</div>'+
              '</div>'+
          '</li>';
      }
      $('#messages').append(saved_messages);
    }else if(message['message-type']=='update-online-users'){
      $('#online').text(message['message-body']);
    }else{
      let output;
      if(message['senderID']==$('#current_user_id').val()){
        output = 
          '<li>'+
              '<div class="d-flex justify-content-end mb-3">'+
                  '<div class="w-75 border border-primary rounded-lg p-2">'+
                      '<strong>You</strong><br>'+
                          message['message-body']['message'] +
                  '</div>'+
              '</div>'+
          '</li>';
      }else{
        output = 
          '<li>'+
              '<div class="d-flex justify-content-start mb-3">'+
                  '<div class="w-75 border border-danger rounded-lg p-2">'+
                      '<strong>'+ message['message-body']['sender'] +'</strong><br>'+
                          message['message-body']['message'] +
                  '</div>'+
              '</div>'+
          '</li>';            
      }
      $('#messages').append(output);
      shouldScroll = messages_container.scrollTop + messages_container.clientHeight === messages_container.scrollHeight;
      if (!shouldScroll) {
          scrollToBottom();
      }
    }
  };
  
  function scrollToBottom() {
    messages_container.scrollTop = messages_container.scrollHeight;
  }

  chatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

  $('#send_message').focus();
  $('#send_message').keyup(function(e){
    if (e.keyCode === 13) {  // enter, return
          $('#send').click();
      }
  });

  $('#send').click(function(){
    let message = $('#send_message').val();
    let sender = $('#current_user').val();
    let user_id = $('#current_user_id').val();
    chatSocket.send(JSON.stringify({
        'message': message,
        'sender': sender,
        'user_id': user_id
    }));
    $('#send_message').val('');
  });
});  

</script>
</html>

{% else %}




<!DOCTYPE html>
<html  >
<head>
  <!-- Site made with Mobirise Website Builder v4.12.4, m -->
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Mobirise v4.12.4, mobirise.com">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/logo2.png" type="image/x-icon">
  <meta name="description" content="">


  <title>Page 1</title>
  <link rel="stylesheet" href=" /static/css/assets/web/assets/mobirise-icons/mobirise-icons.css  ">
  <link rel="stylesheet" href="  /static/css/assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="   /static/css/assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="   /static/css/assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="   /static/css/assets/socicon/css/styles.css">
  <link rel="stylesheet" href="   /static/css/assets/dropdown/css/style.css">
  <link rel="stylesheet" href="   /static/css/assets/tether/tether.min.css">
  <link rel="stylesheet" href="   /static/css/assets/theme/css/style.css">
  <link rel="stylesheet" href="    /static/css/assets/gallery/style.css">
  <link rel="preload" as="style" href="  /static/css/assets/mobirise/css/mbr-additional.css">
  <link rel="stylesheet" href="  /static/css/assets/mobirise/css/mbr-additional.css " type="text/css">



</head>


</head>
<body>
    <section class="menu cid-s4ef8Qp9jL" once="menu" id="menu1-o">



        <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-toggleable-sm">
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            <div class="menu-logo">
                <div class="navbar-brand">
                    <span class="navbar-logo">

                    </span>
                    <span class="navbar-caption-wrap">
                        <a class="navbar-caption text-white display-4" href="">
                            website
                        </a>
                    </span>
                </div>
            </div>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav nav-dropdown" data-app-modern-menu="true"><li class="nav-item">
                        <a class="nav-link link text-white display-4" href="">
                            <span class="mbri-home mbr-iconfont mbr-iconfont-btn"></span>
                            Services
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link link text-white display-4">
                            <span class="mbri-search mbr-iconfont mbr-iconfont-btn"></span>
                            About Us
                        </a>
                    </li></ul>
                <div class="navbar-buttons mbr-section-btn">
                    <a class="btn btn-sm btn-primary display-4" href="">
                        <span class="mbri-save mbr-iconfont mbr-iconfont-btn "></span>
                        Try It Now!
                    </a>
                </div>
            </div>
        </nav>
    </section>

<section class="cid-s3XJNQz8I9" id="footer1-b">




    <br>
    <br>


        <div class="container">
            <div class="media-container-row content text-white">
                <div class="col-12 col-md-3">
                    <div class="media-wrap">

                    </div>
                </div>
                <div class="col-12 col-md-3 mbr-fonts-style display-7">
                    <h5 class="pb-3">
                        Hello
                    </h5>
                    <p class="mbr-text">
                        signup and enjoy reading posts
                        login to create your posts
                    </p>
                </div>
                <div class="col-12 col-md-3 mbr-fonts-style display-7">

                </div>
            </div>
            </div>
            <div class="footer-lower">
                <div class="media-container-row">
                    <div class="col-sm-12">
                        <hr>
                    </div>
                </div>
                <div class="media-container-row mbr-white">
                    <div class="col-sm-6 copyright">
                        <p class="mbr-text mbr-fonts-style display-7">
                         please login and enjoy reading
                        </p>
                        <a href="login">Login Here </a> OR
                        <a href="signup">Sign Up Here</a>
                    </div>

                </div>
            </div>
        </div>
    </section>
    <script src=" /static/css/assets/web/assets/jquery/jquery.min.js "></script>
    <script src="  /static/css/assets/popper/popper.min.js "></script>
    <script src="   /static/css/assets/bootstrap/js/bootstrap.min.js "></script>
    <script src="   /static/css/assets/smoothscroll/smooth-scroll.js "></script>
    <script src="   /static/css/assets/dropdown/js/nav-dropdown.js "></script>
    <script src="   /static/css/assets/dropdown/js/navbar-dropdown.js "></script>
    <script src="    /static/css/assets/touchswipe/jquery.touch-swipe.min.js "></script>
    <script src="    /static/css/assets/masonry/masonry.pkgd.min.js"></script>
    <script src="     /static/css/assets/imagesloaded/imagesloaded.pkgd.min.js"></script>
    <script src="    /static/css/assets/bootstrapcarouselswipe/bootstrap-carousel-swipe.js"></script>
    <script src="   /static/css/assets/tether/tether.min.js"></script>
    <script src="   /static/css/assets/vimeoplayer/jquery.mb.vimeo_player.js"></script>
    <script src="     /static/css/assets/parallax/jarallax.min.js"></script>
    <script src="  /static/css/assets/theme/js/script.js"></script>
    <script src="   /static/css/assets/slidervideo/script.js"></script>
    <script src="   /static/css/assets/gallery/player.min.js"></script>
    <script src="   /static/css/assets/gallery/script.js"></script>
    <script src="   /static/css/assets/formoid/formoid.min.js"></script>



</body>
</html>
{% endif %}